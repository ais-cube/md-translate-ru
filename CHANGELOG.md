# Changelog

## [1.4.2] - 2026-02-21

### Добавлено

- **repair_markdown()** - автоматическое восстановление markdown-разметки потерянной при переводе:
  - Восстановление заголовков (#, ##, ###) по структуре исходника с балльной оценкой кандидатов
  - Восстановление жирного текста (**) в списках и label-паттернах
  - Строгая фильтрация: строки с точкой на конце, длинные предложения - не считаются заголовками
  - Последовательное сопоставление кандидатов с исходными заголовками по порядку
- **Markdown-правила в system prompt** - конкретные примеры форматирования (#, **, |, -, >, ```) с пометкой ОБЯЗАТЕЛЬНО
- **Positive/negative примеры в user prompt** - показываем LLM правильный и неправильный перевод
- **validate_markdown()** - проверка сохранности разметки с предупреждениями

### Изменено

- Пайплайн: repair -> validate -> cleanup -> assemble (в правильном порядке)
- System prompt: добавлен раздел "ФОРМАТ ВЫВОДА: MARKDOWN (ОБЯЗАТЕЛЬНО)" с примерами всех элементов

## [1.4.1] - 2026-02-21

### Исправлено

- **Флаг перевода картинок** - `translate_images` теперь проходит всю цепочку: main() -> translate_document() -> translate_text() -> build_user_prompt()
- **Атрибуция** - формат изменен на `Переведено с помощью **https://github.com/ais-cube/md-translate-ru**` (жирный URL)
- **Лишние переводы строк** - новая функция `cleanup_markdown()` объединяет разбитые предложения в параграфы
- **Таблицы** - сохраняются как markdown-таблицы во всех форматах (MD/HTML/PDF/DOCX)
- **Жирные заголовки** - явный `font-weight: 700` в HTML CSS, подтверждено в PDF (bold шрифт) и DOCX (add_heading)
- **Иерархия форматирования** - промпт содержит явную инструкцию: # = документ, ## = разделы, ### = подразделы
- **Markdown форматирование** - cleanup_markdown гарантирует: 1 пустая строка между блоками, параграфы без разрывов, таблицы целые
- **Двойные пустые строки после таблиц** - убраны

### Изменено

- Промпт перевода полностью переписан: 10 правил форматирования вместо 8, явные инструкции по таблицам, параграфам, иерархии
- Удален хак с system_prompt += для translate_alt_text (теперь через параметр в build_user_prompt)

## [1.4.0] - 2026-02-21

### Добавлено

- **Двуязычный интерфейс** (RU/EN) - выбор языка при первом запуске, запоминается в `.run_config.json`
  - Переключение через `s` при повторном запуске или `--ui-lang ru|en`
  - Все сообщения, шаги, итоги - на выбранном языке
- **Автопроверка зависимостей** - при старте проверяет все пакеты, подсказывает pip-команду
- **Диалог про картинки** - обнаруживает `![alt](path)` в файлах, спрашивает нужно ли переводить alt-text
- **Атрибуция** - в начало переведенного документа добавляется "Переведено с помощью md-translate-ru" на языке перевода (8 языков)
- **Дедупликация заголовков** - автоматическое удаление дубликатов заголовков и разбитых на строки хедеров (защита от артефактов LLM)
- **Папка `output/`** - создана по умолчанию с `.gitkeep`, результаты сохраняются туда
- **Запоминание настроек** - язык интерфейса, последняя языковая пара, выходная папка

### Улучшено

- **HTML** - переносы слов (word-wrap, hyphens), адаптивность для мобильных, justify, стили для blockquote/lists/images
- **Промпт перевода** - явный запрет на дублирование заголовков и разбивку на строки, инструкция по изображениям
- **generate_html** - определяет `lang=` по целевому языку, расширенные CSS-стили
- **generate_outputs** - принимает `lang_pair` для корректного вывода

### Исправлено

- Дублирование "Содержание / Содержание" в переводе
- Дублирование заголовков "Глава 1: Введение в Prompt Engineering" в двух строках
- HTML без word-wrap и переносов на длинных строках
- `--help` блокировался проверкой зависимостей

## [1.3.0] - 2026-02-21

### Добавлено

- **Единый пайплайн** (`run.py`) - одна команда: документ на входе -> перевод -> все форматы на выходе
  - Поддержка входных форматов: .md, .docx, .pdf
  - Выбор языка перевода: 11 языковых пар (EN-RU, RU-EN, EN-DE, EN-ES, EN-FR, EN-ZH, EN-JA и др.)
  - Интерактивное меню с пошаговой настройкой
  - Прогноз стоимости и времени перед запуском
  - Генерация DOCX через python-docx (заголовки, таблицы, списки, code blocks)
  - Сборка нескольких файлов в один выходной документ
- **Мульти-формат выход** (`convert.py`) - генерация PDF + HTML + MD из переведенных файлов
- **Локальные шрифты** (`fonts/`) - DejaVu Sans, DejaVu Sans Mono, Liberation Sans с полной кириллицей
- PDF-генератор с поддержкой заголовков, таблиц, code blocks, списков, цитат
- HTML-генератор с адаптивным дизайном и print-friendly стилями
- Интерактивное меню в `convert.py` (автопоиск папок, выбор формата)

### Изменено

- `requirements.txt` - добавлены `fpdf2`, `markdown`, `pymdown-extensions`, `python-docx`, `pdfplumber`
- `.gitignore` - добавлены `output/`, `docs_ru/`, сохранены шрифты

### Исправлено

- Batch API: sanitize custom_id (убраны точки и спецсимволы)

## [1.2.0] - 2026-02-20

### Добавлено

- **Интерактивное меню** с выбором действий при запуске без аргументов
- **Контроль бюджета** (`--budget 5.00`) - перевод останавливается, если следующий файл не укладывается в остаток
- **Прогноз перед запуском** - таблица с оценкой времени и стоимости по каждому файлу
- **Описание файлов** - краткое описание и метаданные перед переводом каждого файла
- **Graceful interrupt** (Ctrl+C) - остановка после текущего файла, повторный Ctrl+C - немедленный выход
- **Rich CLI** - цветной вывод, прогресс-бар, панели (fallback на plain text без `rich`)
- Флаг `--no-interactive` для CI/CD

### Изменено

- `requirements.txt` - добавлена зависимость `rich>=13.0.0`

## [1.1.0] - 2026-02-20

### Добавлено

- Скрипт `translate_images.py` - перевод изображений через Claude Vision API
- Структурированный Markdown-выход: тип, описание, текстовые элементы EN -> RU, alt-текст
- Автоматический сбор alt-текстов из docs_en/*.md
- Единый JSON (`image_translations.json`) и сводная таблица (`image_summary.md`)
- Batch API для изображений
- Пример выходного файла `examples/images_ru_text/fig-006.md`

## [1.0.0] - 2026-02-20

### Добавлено

- Основной скрипт перевода `translate_api.py`
- Поддержка глоссариев (`glossary.json`)
- Автоматическая разбивка больших файлов на чанки по заголовкам
- Anti-AI cleanup через HUMANIZER.md
- Batch API для двукратной экономии
- Dry-run режим для оценки стоимости
- Сбор терминов-кандидатов в `glossary_candidates.json`
- Примеры в `examples/`
